<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="favicon.png">
  <meta charset="UTF-8">
  <title>Course Advising Form | ODU</title>
  <link rel="stylesheet" href="style.css">

  <style>
    body { background:#f4f6fa; font-family:Segoe UI, Arial, sans-serif; }
    .container { max-width:800px;margin:50px auto;background:white;padding:40px;border-radius:14px;box-shadow:0 8px 25px rgba(0,0,0,.1);}
    h2{text-align:center;margin-bottom:20px;}
    label{font-weight:600;margin-top:15px;display:block;}
    select,input{width:100%;padding:11px;border-radius:8px;border:1px solid #ccc;font-size:16px;}
    .course-row{display:flex;gap:10px;margin-bottom:10px;}
    .course-row select{flex:1;}
    button{margin-top:15px;padding:12px;font-size:16px;background:#0050b3;color:white;border:none;border-radius:8px;cursor:pointer;}
    button:hover{background:#003a80;}
    .remove-btn{background:#b02a37;}
    .disabled-option{color:#999;background:#eee;}
    footer{text-align:center;margin-top:25px;color:#777;}
  </style>
</head>

<body>

<div class="container">
  <h2>Course Advising Form</h2>

  <form id="advisingForm">
    <input type="hidden" id="formId">

    <label>Email</label>
    <input type="email" id="email" readonly>

    <label>Current Term</label>
    <select id="currentTerm" required>
      <option value="">Select Term</option>
      <option>Fall 2023</option><option>Spring 2023</option>
      <option>Fall 2024</option><option>Spring 2024</option>
      <option>Fall 2025</option><option>Spring 2025</option>
      <option>Fall 2026</option><option>Spring 2026</option>
      <option>Fall 2027</option><option>Spring 2027</option>
    </select>

    <label>Last GPA</label>
    <select id="lastGPA" required></select>

    <label>Status</label>
    <select id="status">
      <option value="Pending">Pending</option>
      <option value="Approved">Approved</option>
      <option value="Rejected">Rejected</option>
    </select>

    <h3>Selected Courses</h3>
    <p>Completed courses are disabled.</p>

    <div id="course-list"></div>

    <button type="button" id="addCourseBtn">+ Add Course</button>
    <button type="submit">Save Advising Form</button>

  </form>

  <footer>© 2025 Old Dominion University</footer>
</div>

<script>
const BASE = "https://cs418518-f25-clean.onrender.com/advising";
const email = localStorage.getItem("userEmail");
const formId = new URLSearchParams(window.location.search).get("formId");

document.getElementById("email").value = email;

// GPA
const gpa = document.getElementById("lastGPA");
for(let g=4; g>=0; g-=.01){
  const v = g.toFixed(2);
  gpa.innerHTML += `<option value="${v}">${v}</option>`;
}

// Normalize helper (FIXES DASH BUG)
function norm(v){ return v.replace(/–/g,"-").toLowerCase().trim(); }

// Courses
const COURSES = [
  "CS 150 – Intro to Programming",
  "CS 250 – Problem Solving",
  "CS 255 – Computer Architecture",
  "CS 330 – Object Oriented Programming",
  "CS 350 – Software Engineering",
  "CS 360 – Databases",
  "CS 370 – Operating Systems",
  "CS 380 – Networks",
  "CS 390 – Security",
  "CS 400 – Software Testing",
  "CS 410 – Artificial Intelligence",
  "CS 420 – Machine Learning",
  "CS 430 – Web Development",
  "CS 440 – Mobile Development",
  "CS 450 – Capstone Project"
];

let completed = [];
let selected = [];

// Load completed
async function loadTakenCourses(){
  const res = await fetch(`${BASE}/taken-courses?email=${encodeURIComponent(email)}`);
  const data = await res.json();
  completed = data.map(c => norm(c.course_name));
}

// Render rows
function render(){
  const wrap = document.getElementById("course-list");
  wrap.innerHTML = "";

  selected.forEach((value,i)=>{
    let options = `<option value="">Select course</option>`;

    COURSES.forEach(c=>{
      const disabled = completed.includes(norm(c));
      const sel = value === c ? "selected":"";
      const dis = disabled ? "disabled class='disabled-option'" : "";
      const label = disabled ? `${c} (Completed)` : c;
      options += `<option ${dis} ${sel}>${label}</option>`;
    });

    const row = document.createElement("div");
    row.className = "course-row";
    row.innerHTML = `
      <select onchange="updateCourse(${i},this.value)">${options}</select>
      <button type="button" class="remove-btn" onclick="removeCourse(${i})">X</button>
    `;
    wrap.appendChild(row);
  });
}

function addCourse(){ selected.push(""); render(); }
function removeCourse(i){ selected.splice(i,1); render(); }
function updateCourse(i,v){ selected[i]=v; }

// Load form
async function loadForm(){
  await loadTakenCourses();

  if(!formId){ addCourse(); return; }

  const res = await fetch(`${BASE}/form?formId=${formId}`);
  const data = await res.json();

  document.getElementById("currentTerm").value = data.form.current_term;
  document.getElementById("lastGPA").value = Number(data.form.last_gpa).toFixed(2);
  document.getElementById("status").value = data.form.status;

  // Lock status
  if(data.form.status !== "Pending")
    document.getElementById("status").disabled = true;

  selected = data.selectedCourses.map(c=>c.name);
  render();
}

// Submit
document.getElementById("advisingForm").onsubmit = async e=>{
  e.preventDefault();
  const clean = [...new Set(selected.filter(Boolean))];
  if(!clean.length) return alert("Select at least one course.");

  const payload = {
    formId,email,
    currentTerm: currentTerm.value,
    lastGPA: lastGPA.value,
    status: status.value,
    selectedCourses: clean
  };

  const res = await fetch(`${BASE}/save`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  const data = await res.json();
  data.success ? location="classes.html" : alert(data.message || "Save failed");
};

addCourseBtn.onclick = addCourse;
loadForm();
</script>
</body>
</html>
