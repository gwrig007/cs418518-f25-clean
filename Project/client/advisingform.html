<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advising Form</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="container">
  <h1>Course Advising Form</h1>

  <form id="advisingForm">
    <input type="hidden" id="userId" />
    <input type="hidden" id="formId" />

    <label>Email</label>
    <input type="email" id="email" readonly />

    <label>Current Term</label>
    <select id="currentTerm" required>
      <option value="">Select Term</option>
      <option>Fall 2024</option><option>Spring 2025</option>
      <option>Fall 2025</option><option>Spring 2026</option>
    </select>

    <label>Last GPA</label>
    <select id="lastGPA">
      <option value="">Select GPA</option>
      <option>4.0</option><option>3.9</option><option>3.8</option>
      <option>3.7</option><option>3.6</option><option>3.5</option>
    </select>

    <label>Last Term Completed</label>
    <select id="lastTerm">
      <option value="">Select Term</option>
      <option>Fall 2023</option><option>Spring 2024</option>
      <option>Fall 2024</option>
    </select>

    <h3>Select Courses</h3>

    <label>Choose Course</label>
    <select id="courseSelect">
      <option value="">Choose a Course</option>
      <option>CS 150 – Intro to Programming</option>
      <option>CS 250 – Problem Solving</option>
      <option>CS 361 – Data Structures</option>
    </select>

    <label>Course Status</label>
    <select id="courseStatus">
      <option value="Planned">Planned</option>
      <option value="Current">Current</option>
      <option value="Completed">Completed</option>
    </select>

    <label>Course Term</label>
    <select id="courseTerm">
      <option value="">Select Term</option>
      <option>Fall 2024</option><option>Spring 2025</option>
    </select>

    <button type="button" id="addCourseBtn">Add Course</button>

    <div id="selectedCoursesList"></div>

    <button type="submit">Save Advising Form</button>
  </form>
</div>

<script>
const BASE_URL = "https://cs418518-f25-clean.onrender.com/advising";

let email = localStorage.getItem("userEmail");
document.getElementById("email").value = email;

let selectedCourses = [];
let userId = null;

/* ---------------------------------------------------------
   GET USER ID
--------------------------------------------------------- */
fetch(`https://cs418518-f25-clean.onrender.com/users/by-email?email=${email}`)
  .then(res => res.json())
  .then(data => {
    userId = data.user_id;
    document.getElementById("userId").value = userId;

    loadTakenCourses();
  });

/* ---------------------------------------------------------
   LOAD TAKEN COURSES
--------------------------------------------------------- */
function loadTakenCourses() {
  fetch(`${BASE_URL}/courses/${userId}`)
    .then(res => res.json())
    .then(data => {
      let taken = data.map(c => c.course_name);
      disableTaken(taken);
    });
}

function disableTaken(taken) {
  const options = document.querySelectorAll("#courseSelect option");
  options.forEach(opt => {
    if (taken.includes(opt.textContent)) {
      opt.disabled = true;
      opt.style.opacity = "0.4";
    }
  });
}

/* ---------------------------------------------------------
   ADD COURSE
--------------------------------------------------------- */
document.getElementById("addCourseBtn").addEventListener("click", () => {
  const course = document.getElementById("courseSelect").value;
  const status = document.getElementById("courseStatus").value;
  const term = document.getElementById("courseTerm").value;

  if (!course || !term) return alert("Choose course + term.");

  selectedCourses.push({ course_name: course, status, term });
  renderCourses();
});

function renderCourses() {
  const list = document.getElementById("selectedCoursesList");
  list.innerHTML = "";

  selectedCourses.forEach((c, i) => {
    const div = document.createElement("div");
    div.innerHTML = `${c.course_name} — ${c.status} (${c.term})
      <button onclick="removeCourse(${i})">X</button>`;
    list.appendChild(div);
  });
}

function removeCourse(i) {
  selectedCourses.splice(i, 1);
  renderCourses();
}

/* ---------------------------------------------------------
   SAVE FORM
--------------------------------------------------------- */
document.getElementById("advisingForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const payload = {
    userId,
    currentTerm: document.getElementById("currentTerm").value,
    lastGpa: document.getElementById("lastGPA").value,
    lastTerm: document.getElementById("lastTerm").value,
    selectedCourses
  };

  const res = await fetch(`${BASE_URL}/save`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const result = await res.json();

  if (result.advisingId) {
    alert("Saved!");
    window.location.href = "classes.html";
  } else {
    alert("Error saving form.");
  }
});
</script>

</body>
</html>
