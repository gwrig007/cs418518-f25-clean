<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advising Form | ODU</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .container {
      max-width: 750px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; margin-bottom: 20px; }
    label { font-weight: 600; display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
    #courses-container label { display: block; margin-bottom: 5px; }
    button { width: 100%; margin-top: 20px; padding: 12px; font-size: 18px; background: #0050b3; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #003d8a; }
    .disabled { background-color: #eee !important; pointer-events: none; opacity: 0.7; }
  </style>
</head>
<body>

<div class="container">
  <h1>Course Advising Form</h1>
  <form id="advisingForm">
    <input type="hidden" id="formId" />
    <label>Email</label>
    <input type="email" id="email" readonly />
    
    <label>Current Term</label>
    <select id="currentTerm" required>
      <option value="">Select term</option>
      <option>Fall 2023</option><option>Spring 2023</option>
      <option>Fall 2024</option><option>Spring 2024</option>
      <option>Fall 2025</option><option>Spring 2025</option>
      <option>Fall 2026</option><option>Spring 2026</option>
      <option>Fall 2027</option><option>Spring 2027</option>
    </select>

    <label>Last GPA</label>
    <select id="lastGPA" required></select>

    <label>Form Status</label>
    <select id="status" required>
      <option value="Pending">Pending</option>
      <option value="Accepted">Accepted</option>
      <option value="Rejected">Rejected</option>
    </select>

    <label>Choose Your Courses</label>
    <div id="courses-container"></div>

    <button type="submit" id="submitBtn">Submit Form</button>
    <button type="button" onclick="window.location.href='classes.html'">Back</button>
  </form>
</div>

<script>
const BASE_URL = "https://cs418518-f25-clean.onrender.com/advising";
let email = localStorage.getItem("userEmail");
const params = new URLSearchParams(window.location.search);
const formId = params.get("formId");

// Redirect if no email
if (!email) {
  alert("You must sign in to access this page.");
  window.location.href = "signin.html";
}
document.getElementById("email").value = email;

// GPA dropdown
const gpaSelect = document.getElementById("lastGPA");
for (let g = 4.00; g >= 0; g -= 0.01) {
  gpaSelect.innerHTML += `<option value="${g.toFixed(2)}">${g.toFixed(2)}</option>`;
}

// Master 15 courses
const MASTER_COURSES = [
  "CS101 - Intro to CS",
  "CS102 - Data Structures",
  "CS201 - Algorithms",
  "CS202 - Computer Architecture",
  "CS301 - Operating Systems",
  "CS302 - Databases",
  "CS303 - Networking",
  "CS304 - Software Engineering",
  "CS305 - AI Basics",
  "CS306 - Machine Learning",
  "CS307 - Web Development",
  "CS308 - Mobile Development",
  "CS309 - Cybersecurity",
  "CS310 - Cloud Computing",
  "CS311 - Capstone Project"
];

// Load courses and disable already taken
async function loadCourses() {
  try {
    const res = await fetch(`${BASE_URL}/taken-courses?email=${encodeURIComponent(email)}`);
    const taken = await res.json();
    const container = document.getElementById("courses-container");
    container.innerHTML = "";

    MASTER_COURSES.forEach(course => {
      const disabled = taken.includes(course) ? "disabled" : "";
      container.innerHTML += `
        <label>
          <input type="checkbox" name="selectedCourses" value="${course}" ${disabled}>
          ${course} ${disabled ? "(Taken)" : ""}
        </label>
      `;
    });

    // If editing existing form, check previously selected courses
    if (formId) {
      const formRes = await fetch(`${BASE_URL}/form?formId=${formId}`);
      const data = await formRes.json();
      document.getElementById("currentTerm").value = data.form.current_term;
      document.getElementById("lastGPA").value = data.form.last_gpa?.toFixed(2) || "";
      document.getElementById("status").value = data.form.status;

      // Lock if Accepted/Rejected
      if (data.form.status !== "Pending") {
        document.querySelectorAll("select, input").forEach(el => {
          el.classList.add("disabled");
          el.disabled = true;
        });
        document.getElementById("submitBtn").style.display = "none";
      }

      data.courses.forEach(c => {
        const box = document.querySelector(`input[value="${c.course_name}"]`);
        if (box) box.checked = true;
      });
    }

  } catch (err) {
    console.error("Error loading courses:", err);
    document.getElementById("courses-container").innerHTML = "<p>Error loading courses.</p>";
  }
}

loadCourses();

// Handle form submit
document.getElementById("advisingForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const selectedCourses = [...document.querySelectorAll("input[name='selectedCourses']:checked")].map(c => c.value);
  const payload = {
    formId,
    email,
    currentTerm: document.getElementById("currentTerm").value,
    lastGPA: document.getElementById("lastGPA").value,
    status: document.getElementById("status").value,
    selectedCourses
  };

  try {
    const res = await fetch(`${BASE_URL}/save`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (res.ok) {
      alert("Advising form saved successfully!");
      window.location.href = "classes.html";
    } else {
      alert(data.message || data.error || "Error saving form.");
    }
  } catch (err) {
    console.error("Save error:", err);
    alert("Error saving form.");
  }
});
</script>

</body>
</html>
