<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="favicon.png">
  <meta charset="UTF-8">
  <title>Course Advising Form | ODU</title>
  <link rel="stylesheet" href="style.css">

  <style>
    .container {
      max-width: 750px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    label { font-weight: 600; display: block; margin-top: 12px; }
    select, input {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      width: 100%;
      margin-top: 20px;
      padding: 12px;
      font-size: 18px;
      background: #0050b3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover { background: #003d8a; }

    .course-row {
      margin-bottom: 10px;
    }

    .disabled-option {
      color: #999;
      background: #f1f1f1;
    }
  </style>
</head>

<body>

<header>
  <div style="display:flex;align-items:center;gap:15px;">
    <img src="https://upload.wikimedia.org/wikipedia/en/2/2d/Old_Dominion_Monarchs_logo.svg" style="height:60px;">
    <h2>ODU Course Advising Portal</h2>
  </div>
</header>

<div class="container">
  <h2>Course Advising Form</h2>

  <form id="advisingForm">
    <input type="hidden" id="formId">

    <label>Email</label>
    <input type="email" id="email" readonly>

    <label>Current Term</label>
    <select id="currentTerm" required>
      <option value="">Choose term</option>
      <option>Fall 2023</option><option>Spring 2023</option>
      <option>Fall 2024</option><option>Spring 2024</option>
      <option>Fall 2025</option><option>Spring 2025</option>
      <option>Fall 2026</option><option>Spring 2026</option>
      <option>Fall 2027</option><option>Spring 2027</option>
    </select>

    <label>Last GPA</label>
    <select id="lastGPA" required></select>

    <h3>Choose Courses</h3>
    <p>Completed courses are disabled.</p>

    <div id="courses-wrapper"></div>

    <button type="submit">Submit Advising Form</button>
    <button type="button" onclick="window.location.href='classes.html'" style="margin-top:8px;">Back</button>
  </form>
</div>

<script>
const BASE = "https://cs418518-f25-clean.onrender.com/advising";
const email = localStorage.getItem("userEmail");
const formId = new URLSearchParams(window.location.search).get("formId");

if (!email) {
  alert("Please sign in.");
  window.location.href = "signin.html";
}
document.getElementById("email").value = email;

// GPA values
const gpa = document.getElementById("lastGPA");
for (let i = 4.0; i >= 0; i -= 0.01) {
  const v = i.toFixed(2);
  gpa.innerHTML += `<option value="${v}">${v}</option>`;
}

// Course catalog
const COURSES = [
  "CS 150 – Intro to Programming",
  "CS 250 – Problem Solving",
  "CS 255 – Computer Architecture",
  "CS 330 – Object Oriented Programming",
  "CS 350 – Software Engineering",
  "CS 360 – Databases",
  "CS 370 – Operating Systems",
  "CS 380 – Networks",
  "CS 390 – Security",
  "CS 400 – Software Testing",
  "CS 410 – Artificial Intelligence",
  "CS 420 – Machine Learning",
  "CS 430 – Web Development",
  "CS 440 – Mobile Development",
  "CS 450 – Capstone Project"
];

let takenCourses = [];

// Load completed courses
async function loadTakenCourses() {
  const res = await fetch(`${BASE}/taken-courses?email=${encodeURIComponent(email)}`);
  const data = await res.json();
  takenCourses = data.map(c => c.course_name);
}

// Render 15 dropdowns
async function renderDropdowns(selected = []) {
  await loadTakenCourses();
  const wrap = document.getElementById("courses-wrapper");
  wrap.innerHTML = "";

  for (let i = 0; i < 15; i++) {
    const chosen = selected[i] || "";

    let options = `<option value="">Select course</option>`;

    COURSES.forEach(course => {
      const taken = takenCourses.includes(course);
      const disabled = taken ? "disabled class='disabled-option'" : "";
      const selectedAttr = chosen === course ? "selected" : "";
      const label = taken ? `${course} (Completed)` : course;

      options += `<option value="${course}" ${disabled} ${selectedAttr}>${label}</option>`;
    });

    wrap.innerHTML += `
      <div class="course-row">
        <select class="courseSelect">${options}</select>
      </div>
    `;
  }
}

// Load form if editing
async function loadForm() {
  if (!formId) {
    renderDropdowns();
    return;
  }

  const res = await fetch(`${BASE}/form?formId=${formId}`);
  const data = await res.json();

  document.getElementById("currentTerm").value = data.form.current_term;
  document.getElementById("lastGPA").value = Number(data.form.last_gpa).toFixed(2);

  const selected = data.selectedCourses.map(c => c.name);
  renderDropdowns(selected);
}

// Submit
document.getElementById("advisingForm").addEventListener("submit", async e => {
  e.preventDefault();

  const selections = [...document.querySelectorAll(".courseSelect")]
    .map(s => s.value)
    .filter(Boolean);

  const payload = {
    formId,
    email,
    currentTerm: document.getElementById("currentTerm").value,
    lastGPA: document.getElementById("lastGPA").value,
    selectedCourses: selections
  };

  const res = await fetch(`${BASE}/save`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  if (data.success) {
    alert("Form saved successfully!");
    window.location.href = "classes.html";
  } else {
    alert("Error saving form.");
  }
});

// Init
loadForm();
</script>

</body>
</html>
