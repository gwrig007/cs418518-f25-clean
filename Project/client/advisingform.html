<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Advising Form</title>
  <link rel="stylesheet" href="style.css">

  <style>
    /* match home.html styling */
    .container {
      max-width: 750px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
    }

    select, input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    #courses-container label {
      display: block;
      margin-bottom: 8px;
    }

    button {
      width: 100%;
      margin-top: 25px;
      padding: 12px;
      font-size: 18px;
      background: #0050b3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #003d8a;
    }

    .disabled {
      background-color: #eee !important;
      pointer-events: none;
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Course Advising Form</h1>

    <form id="advisingForm">
      
      <!-- CURRENT TERM -->
      <label for="currentTerm">Current Term</label>
      <select id="currentTerm" name="currentTerm" required>
        <option value="">Select term</option>
        <option>Fall 2023</option><option>Spring 2023</option>
        <option>Fall 2024</option><option>Spring 2024</option>
        <option>Fall 2025</option><option>Spring 2025</option>
        <option>Fall 2026</option><option>Spring 2026</option>
        <option>Fall 2027</option><option>Spring 2027</option>
      </select>

      <!-- GPA DROPDOWN -->
      <label for="lastGPA">Last GPA</label>
      <select id="lastGPA" name="lastGPA" required>
        <option value="">Select GPA</option>
      </select>

      <!-- STATUS SELECT -->
      <label for="status">Form Status</label>
      <select id="status" name="status" required>
        <option value="Pending">Pending</option>
        <option value="Accepted">Accepted</option>
        <option value="Rejected">Rejected</option>
      </select>

      <!-- COURSES -->
      <label>Choose Your Courses</label>
      <div id="courses-container"></div>

      <button type="submit" id="submitBtn">Submit Form</button>
    </form>
  </div>

  <script>
    const email = localStorage.getItem("userEmail"); 
    const params = new URLSearchParams(window.location.search);
    const formId = params.get("id") || null;

    /* ---------------- GPA DROPDOWN ---------------- */
    const gpaSelect = document.getElementById("lastGPA");
    for (let g = 4.00; g >= 0; g -= 0.01) {
      gpaSelect.innerHTML += `<option value="${g.toFixed(2)}">${g.toFixed(2)}</option>`;
    }

    /* ---------------- LOAD COURSES ---------------- */
    async function loadCourses() {
      const res = await fetch(`/advising/current-courses?email=${email}`);
      const data = await res.json();

      const container = document.getElementById("courses-container");
      container.innerHTML = "";

      data.forEach(c => {
        container.innerHTML += `
          <label><input type="checkbox" name="selectedCourses" value="${c}"> ${c}</label>
        `;
      });
    }

    loadCourses();

    /* ---------------- LOAD EXISTING FORM ---------------- */
    if (formId) {
      fetch(`/advising/form?formId=${formId}`)
        .then(res => res.json())
        .then(f => {
          document.getElementById("currentTerm").value = f.current_term;
          document.getElementById("lastGPA").value = f.last_gpa.toFixed(2);
          document.getElementById("status").value = f.status;

          // lock if accepted or rejected
          if (f.status !== "Pending") {
            document.querySelectorAll("select, input").forEach(el => {
              el.classList.add("disabled");
              el.disabled = true;
            });
            document.getElementById("submitBtn").style.display = "none";
          }

          // check courses
          f.selectedCourses.forEach(c => {
            const box = document.querySelector(`input[value="${c}"]`);
            if (box) box.checked = true;
          });
        });
    }

    /* ---------------- HANDLE FORM SUBMIT ---------------- */
    document.getElementById("advisingForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const selected = [...document.querySelectorAll('input[name="selectedCourses"]:checked')].map(c => c.value);

      const payload = {
        formId,
        email,
        currentTerm: document.getElementById("currentTerm").value,
        lastGPA: document.getElementById("lastGPA").value,
        status: document.getElementById("status").value,
        selectedCourses: selected
      };

      const res = await fetch("/advising/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (data.success) {
        alert("Advising form submitted!");
        window.location.href = "classes.html";
      }
    });
  </script>
</body>
</html>
