<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Advising Dashboard | ODU</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1, h2 { margin-top:25px; }
    .course-box, .form-row {
      background:#f9f9f9; 
      padding:12px 15px; 
      margin:8px 0; 
      border-radius:6px; 
      border:1px solid #ddd;
    }
    .form-status { font-weight:bold; }
    .btn { 
      display:inline-block; 
      margin-top:20px; 
      padding:12px 20px; 
      background:#0050b3; 
      color:white; 
      border-radius:6px; 
      text-decoration:none; 
      transition:0.2s;
    }
    .btn:hover { background:#003d8a; }
    .view-btn { 
      padding:8px 12px; 
      background:#0066cc; 
      color:white; 
      border-radius:6px; 
      text-decoration:none;
    }
    .view-btn:hover { background:#004c99; }
  </style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:15px;">
    <img src="https://upload.wikimedia.org/wikipedia/en/2/2d/Old_Dominion_Monarchs_logo.svg" alt="ODU Logo" style="height:60px;">
    <h1>ODU Course Advising Portal</h1>
  </div>
</header>

<div class="container">
  <h1>Your Advising Dashboard</h1>
  <button id="newFormBtn" class="btn">➕ New Advising Form</button>

  <h2>Current Courses</h2>
  <div id="currentCourses">Loading...</div>

  <h2>Courses Taken Last Term</h2>
  <div id="takenCourses">Loading...</div>

  <h2>Your Advising Forms</h2>
  <div id="formsList">Loading...</div>

  <button class="btn" onclick="window.location.href='home.html'" style="margin-top:20px;">Back to Home</button>
</div>

<footer>
  © 2025 Old Dominion University | Course Advising System
</footer>

<script>
const BASE_URL = "https://cs418518-f25-clean.onrender.com/advising";
const email = localStorage.getItem("userEmail");
if (!email) {
  alert("You must sign in.");
  window.location.href = "signin.html";
}

// New form button
document.getElementById("newFormBtn").onclick = () => {
  window.location.href = "advisingform.html";
};

// Helper to fetch data
async function fetchData(endpoint) {
  try {
    const res = await fetch(`${BASE_URL}/${endpoint}?email=${encodeURIComponent(email)}`);
    if (!res.ok) throw new Error(`${endpoint} fetch failed: ${res.status}`);
    return await res.json();
  } catch (err) {
    console.error(`${endpoint} fetch failed:`, err);
    return [];
  }
}

// Load Current Courses
async function loadCurrentCourses() {
  const courses = await fetchData("current-courses");
  const container = document.getElementById("currentCourses");
  container.innerHTML = courses.length 
    ? courses.map(c => `<div class="course-box">${c}</div>`).join("")
    : "<p>No current courses found.</p>";
}

// Load Taken Courses
async function loadTakenCourses() {
  const courses = await fetchData("taken-courses");
  const container = document.getElementById("takenCourses");
  container.innerHTML = courses.length
    ? courses.map(c => `<div class="course-box">${c}</div>`).join("")
    : "<p>No courses taken last term.</p>";
}

// Load Advising Forms
async function loadForms() {
  const forms = await fetchData("forms");
  const container = document.getElementById("formsList");
  if (!forms.length) {
    container.innerHTML = "<p>No advising forms submitted yet.</p>";
    return;
  }
  container.innerHTML = forms.map(f => `
    <div class="form-row">
      <div>
        <div><strong>Term:</strong> ${f.current_term}</div>
        <div class="form-status"><strong>Status:</strong> ${f.status}</div>
        <div><small>Submitted: ${new Date(f.created_at).toLocaleString()}</small></div>
      </div>
      <a class="view-btn" href="advisingform.html?formId=${f.id}">View / Edit</a>
    </div>
  `).join("");
}

// Initialize all
loadCurrentCourses();
loadTakenCourses();
loadForms();
</script>

</body>
</html>
