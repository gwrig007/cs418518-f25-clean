<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="favicon.png">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Course Plans | Advising</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f5f5f5;
      font-weight: 600;
    }
    .btn {
      padding: 6px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      margin-right:5px;
    }
    .btn-view { background:#0066cc; color:#fff; }
    .btn-edit { background:#f0ad4e; color:#fff; }

    .note {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #555;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>My Course Plans</h1>

<button onclick="window.location.href='advisingform.html'" style="margin-bottom:15px;">
  ➕ Create New Plan
</button>

  <label for="email">Email</label>
  <input type="email" id="email" readonly />

  <section style="margin-top:20px;">
    <h2>Submitted Advising Forms</h2>
    <p class="note">Approved and Rejected plans are read-only.</p>

    <table id="formsTable">
      <thead>
        <tr>
          <th>Current Term</th>
          <th>Last GPA</th>
          <th>Status</th>
          <th>Submitted At</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p id="noFormsMsg" class="note" style="display:none;">
      You don’t have any advising forms yet.
    </p>
  </section>

  <!-- DETAILS -->
  <section id="planSection" style="margin-top:30px; display:none;">
    <h2>Planned Courses for <span id="planTerm"></span></h2>
    <ul id="planList"></ul>
  </section>

</div>

<script>
  const BASE = "https://cs418518-f25-clean.onrender.com/advising";
  const email = localStorage.getItem("userEmail");
  const emailInput = document.getElementById("email");

  if (!email) window.location.href = "index.html";
  emailInput.value = email;

  const formsTableBody = document.querySelector("#formsTable tbody");
  const noFormsMsg = document.getElementById("noFormsMsg");
  const planSection = document.getElementById("planSection");
  const planTermSpan = document.getElementById("planTerm");
  const planList = document.getElementById("planList");

  async function loadForms() {
    const res = await fetch(`${BASE}/forms?email=${encodeURIComponent(email)}`);
    const forms = await res.json();

    formsTableBody.innerHTML = "";

    if (!Array.isArray(forms) || forms.length === 0) {
      noFormsMsg.style.display = "block";
      return;
    }

    noFormsMsg.style.display = "none";

    forms.forEach(form => {
      const tr = document.createElement("tr");
      const createdAt = form.created_at ? new Date(form.created_at).toLocaleString() : "";
      const isPending = form.status === "Pending";

      tr.innerHTML = `
        <td>${form.current_term || ""}</td>
        <td>${form.last_gpa ?? ""}</td>
        <td>${form.status}</td>
        <td>${createdAt}</td>
        <td>
          <button class="btn btn-view" data-id="${form.id}" data-term="${form.current_term}">
            View
          </button>

          ${isPending ? `
            <button class="btn btn-edit" data-edit="${form.id}">
              Edit
            </button>
          ` : ""}
        </td>
      `;

      formsTableBody.appendChild(tr);
    });
  }

  async function loadPlan(id, term) {
    const res = await fetch(`${BASE}/form?formId=${formId}`);
    const data = await res.json();

    planList.innerHTML = "";
    const courses = data.courses || [];

    if (!courses.length) {
      planList.innerHTML = "<li>No courses found</li>";
    } else {
      courses.forEach(c => {
        const li = document.createElement("li");
        const level = c.course_level || "";
        const name = c.course_name || "";
        li.textContent = level ? `${level} – ${name}` : name;
        planList.appendChild(li);
      });
    }

    planTermSpan.textContent = term;
    planSection.style.display = "block";
    planSection.scrollIntoView({ behavior: "smooth" });
  }

  formsTableBody.addEventListener("click", e => {

    // ✅ EDIT Pending
    const editBtn = e.target.closest("button[data-edit]");
    if (editBtn) {
      const id = editBtn.getAttribute("data-edit");
      window.location.href = `advisingform.html?formId=${id}`;
      return;
    }

    // ✅ VIEW
    const viewBtn = e.target.closest("button[data-id]");
    if (!viewBtn) return;

    loadPlan(viewBtn.dataset.id, viewBtn.dataset.term);
  });

  loadForms();
</script>

</body>
</html>
