<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Classes | ODU Course Advising Portal</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{font-family:"Segoe UI",Arial,sans-serif;background:#fff;color:#003366;margin:0;padding:20px}
    .wrap{max-width:980px;margin:32px auto;background:#fff;padding:24px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.06)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:1.4rem;margin:0}
    .btn{background:#007bff;color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:10px 12px;border-bottom:1px solid #eef2f6;text-align:left}
    tr.clickable:hover{background:#f6f9ff;cursor:pointer}
    .no-records{text-align:center;color:#666;padding:28px 0}
    .section-title{margin-top:28px;font-size:1.1rem;font-weight:600;color:#003366}
    .status-pending{color:#d97706;font-weight:600}
    .status-approved{color:#0f5132;font-weight:600}
    .status-rejected{color:#842029;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>My Course Advising</h1>
      <div><button id="newBtn" class="btn">+ New Advising</button></div>
    </header>

    <div>
      <h2 class="section-title">Currently Registered Courses</h2>
      <table id="currentTable">
        <thead><tr><th>Course</th><th>Term</th><th>Grade</th></tr></thead>
        <tbody id="currentBody"></tbody>
      </table>
      <div id="noCurrent" class="no-records" style="display:none;">No registered courses found.</div>

      <h2 class="section-title">Advising History</h2>
      <table id="historyTable">
        <thead><tr><th>Date</th><th>Term</th><th>Status</th></tr></thead>
        <tbody id="historyBody"></tbody>
      </table>
      <div id="noRecords" class="no-records" style="display:none;">No advising records found.</div>
    </div>
  </div>

<script>
  const API_BASE =
    window.location.hostname.includes("127.0.0.1") || window.location.hostname.includes("localhost")
      ? "http://127.0.0.1:8080"
      : "https://cs418518-f25-clean.onrender.com";

  const email = localStorage.getItem("userEmail");
  if (!email) { alert("Please sign in."); window.location.href = "signin.html"; }

  document.getElementById("newBtn").addEventListener("click", ()=> {
    window.location.href = "advising-form.html";
  });

  // Load both sections
  async function loadCurrent() {
    try {
      const res = await fetch(`${API_BASE}/advising/current?email=${encodeURIComponent(email)}`);
      const data = await res.json();
      const body = document.getElementById("currentBody");
      body.innerHTML = "";
      if (!data || data.length === 0) {
        document.getElementById("noCurrent").style.display = "block";
        document.getElementById("currentTable").style.display = "none";
        return;
      }
      document.getElementById("noCurrent").style.display = "none";
      document.getElementById("currentTable").style.display = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.course}</td><td>${row.term}</td><td>${row.grade ?? "-"}</td>`;
        body.appendChild(tr);
      });
    } catch (err) {
      console.error(err);
      document.getElementById("noCurrent").style.display = "block";
    }
  }

  async function loadHistory() {
    try {
      const res = await fetch(`${API_BASE}/advising/history?email=${encodeURIComponent(email)}`);
      const rows = await res.json();
      const body = document.getElementById("historyBody");
      body.innerHTML = "";
      if (!rows || rows.length === 0) {
        document.getElementById("historyTable").style.display = "none";
        document.getElementById("noRecords").style.display = "block";
        return;
      }
      document.getElementById("historyTable").style.display = "";
      document.getElementById("noRecords").style.display = "none";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "clickable";
        tr.innerHTML = `<td>${r.date}</td><td>${r.term || ""}</td><td class="${statusClass(r.status)}">${r.status}</td>`;
        tr.addEventListener("click", ()=> {
          window.location.href = `advising-form.html?id=${r.id}`;
        });
        body.appendChild(tr);
      });
    } catch (err) {
      console.error(err);
      document.getElementById("noRecords").innerText = "Unable to load advising history.";
      document.getElementById("noRecords").style.display = "block";
    }
  }

  function statusClass(s) {
    if (!s) return "";
    return s.toLowerCase() === "pending" ? "status-pending" :
           s.toLowerCase() === "approved" ? "status-approved" : "status-rejected";
  }

  loadCurrent();
  loadHistory();
</script>
</body>
</html>
