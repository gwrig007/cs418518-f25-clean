<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Classes | ODU Portal</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root {
      --odu-navy: #003366;
      --odu-blue: #00539B;
      --light-gray: #f4f6fa;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--light-gray);
      color: var(--odu-navy);
      margin: 0;
      padding: 24px;
    }

    .wrap {
      max-width: 1000px;
      margin: 24px auto;
      background: #fff;
      padding: 20px 28px;
      border-radius: 10px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
      border: 1px solid #e0e6f0;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 12px;
      color: var(--odu-navy);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e0e6f0;
    }

    th {
      background: var(--odu-blue);
      color: white;
      font-weight: 600;
    }

    .btn {
      background: var(--odu-blue);
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: 500;
    }

    .btn:hover { background: #004080; }

    .btn.secondary {
      background: #6c757d;
    }

    .btn.secondary:hover {
      background: #5a6268;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .msg {
      color: #a30000;
      font-weight: 500;
      margin-top: 10px;
    }

    .logout {
      color: #a30000;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>My Course Advising</h1>
      <div>
        <button id="newFormBtn" class="btn">+ New Advising Form</button>
        <span id="logoutBtn" class="logout">Logout</span>
      </div>
    </div>

    <table id="classesTable">
      <thead>
        <tr>
          <th>Term</th>
          <th>GPA</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <div id="message" class="msg"></div>
  </div>

<script>
  const API_BASE =
    window.location.hostname.includes("127.0.0.1") || window.location.hostname.includes("localhost")
      ? "http://127.0.0.1:8080"
      : "https://cs418518-f25-clean.onrender.com";

  // ✅ Ensure email is consistent
  let email = localStorage.getItem("userEmail");
  const urlParams = new URLSearchParams(window.location.search);
  const urlEmail = urlParams.get("email");

  if (urlEmail && urlEmail !== email) {
    localStorage.setItem("userEmail", urlEmail);
    email = urlEmail;
  }

  if (!email || email === "null" || email.trim() === "") {
    alert("Please sign in again.");
    window.location.href = "signin.html";
  }

  // Push email into the URL for all subsequent actions
  if (!urlEmail) {
    const newUrl = `${window.location.pathname}?email=${encodeURIComponent(email)}`;
    history.replaceState({}, "", newUrl);
  }

  const tableBody = document.getElementById("tableBody");
  const messageEl = document.getElementById("message");
  const newFormBtn = document.getElementById("newFormBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("userEmail");
    window.location.href = "signin.html";
  });

  newFormBtn.addEventListener("click", () => {
    window.location.href = `advisingform.html?email=${encodeURIComponent(email)}`;
  });

  async function loadCurrentCourses() {
    messageEl.textContent = "";
    tableBody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

    try {
      const res = await fetch(`${API_BASE}/advising/list?email=${encodeURIComponent(email)}`);
      if (!res.ok) throw new Error("Unable to fetch courses.");
      const courses = await res.json();

      if (!Array.isArray(courses) || courses.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='4'>No advising records found.</td></tr>";
        return;
      }

      tableBody.innerHTML = "";
      courses.forEach(r => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${r.current_term || "—"}</td>
          <td>${r.last_gpa ?? "—"}</td>
          <td>${r.status || "Pending"}</td>
          <td>
            <button class="btn secondary" onclick="openForm('${r.id}')">View/Edit</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    } catch (err) {
      console.error("Error loading courses:", err);
      messageEl.textContent = "Failed to load your advising records.";
    }
  }

  function openForm(id) {
    window.location.href = `advisingform.html?id=${id}&email=${encodeURIComponent(email)}`;
  }

  loadCurrentCourses();
</script>
</body>
</html>
